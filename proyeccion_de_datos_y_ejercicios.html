<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo: Proyección de Datos y Ejercicios - Guía de PostGIS Bogotá</title>
    <!-- Tailwind CSS para un diseño rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para el contenido del artículo */
        .article-content h2 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 800; /* extrabold */
            color: #1f2937; /* gray-800 */
            margin-top: 2.5rem; /* mt-10 */
            margin-bottom: 1rem; /* mb-4 */
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .article-content h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* bold */
            color: #1f2937; /* gray-800 */
            margin-top: 2rem; /* mt-8 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .article-content p, .article-content ul, .article-content ol {
            font-size: 1.125rem; /* text-lg */
            color: #374151; /* gray-700 */
            line-height: 1.75;
            margin-bottom: 1rem;
        }
        .article-content ul {
            list-style-type: disc;
            padding-left: 2rem;
        }
        .article-content a {
            color: #2563eb; /* blue-600 */
            text-decoration: none;
            transition: color 0.2s;
        }
        .article-content a:hover {
            color: #1d4ed8; /* blue-800 */
            text-decoration: underline;
        }
        .article-content code:not(.hljs) { /* Código inline */
            background-color: #e5e7eb;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .code-block-container {
            position: relative;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .copy-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #4b5563;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #6b7280;
        }
        .copy-button:hover {
            background-color: #374151;
        }
        .copy-button.copied {
            background-color: #16a34a; /* green-600 */
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .styled-table th, .styled-table td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        .styled-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .styled-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
    </style>
    <!-- Highlight.js para el resaltado de sintaxis SQL -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- ===== NAVEGACIÓN DE VUELTA ===== -->
        <nav class="mb-6">
            <a href="index.html" class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200 text-lg">
                &larr; Volver a la página principal de la guía
            </a>
        </nav>

        <!-- ===== CABECERA DEL MÓDULO ===== -->
        <header class="mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
                Proyección de Datos y Ejercicios
            </h1>
            <p class="text-xl text-gray-600">
                Transformando geometrías entre diferentes sistemas de referencia espacial.
            </p>
        </header>

        <article class="bg-white p-6 sm:p-8 lg:p-12 rounded-xl shadow-md border border-gray-200 article-content">
            
            <h2>1. Fundamentos de la Proyección de Datos</h2>
            <p>
                La Tierra es (casi) una esfera, pero los mapas y las pantallas de nuestros computadores son planos. Una <strong>proyección cartográfica</strong> es un conjunto de transformaciones matemáticas que nos permiten representar la superficie curva del planeta en un plano. Este proceso siempre introduce algún tipo de distorsión, ya sea en las áreas, los ángulos o las distancias. La elección de una proyección depende del propósito del análisis.
            </p>
            <p>
                En PostGIS, es crucial que todas las geometrías que se van a comparar o analizar estén en el mismo <strong>Sistema de Referencia Espacial (SRS)</strong>, identificado por un código numérico llamado <strong>SRID</strong>.
            </p>

            <h3>1.1. Verificando el SRID de nuestros datos</h3>
            <p>
                Podemos confirmar fácilmente el SRID de los datos en una tabla con la función <code>ST_SRID()</code>. Idealmente, todas las geometrías de una misma capa deberían tener el mismo SRID.
            </p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Verifica el SRID de la primera geometría en la tabla de barrios de Engativá
SELECT ST_SRID(geom)
FROM barrios_enga 
LIMIT 1;</code></pre>
            </div>
            <p>
                La definición técnica de cada SRID (por ejemplo, 4326 para WGS 84 o 9377 para el Origen Nacional de Colombia) se almacena en la tabla del sistema <code>spatial_ref_sys</code>.
            </p>

            <h3>1.2. Comparación de datos con SRID diferentes</h3>
            <p>
                Si intentas realizar una operación espacial entre geometrías con SRID diferentes, PostGIS te arrojará un error. Esto es una medida de seguridad para evitar cálculos incorrectos. Una coordenada sin un SRID es solo un par de números; el SRID le da su contexto en el mundo real.
            </p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Esto generará un error
SELECT ST_Equals(
    ST_GeomFromText('POINT(0 0)', 4326),  -- Punto en WGS 84
    ST_GeomFromText('POINT(0 0)', 9377)   -- Punto en Origen Nacional
);</code></pre>
            </div>
            <p>El error será: <code>ERROR: ST_Equals: Operation on mixed SRID geometries</code>.</p>

            <h2>2. Transformación de Datos con ST_Transform</h2>
            <p>
                La función clave para trabajar con diferentes sistemas de referencia es <code>ST_Transform(geometry, srid)</code>. Esta función toma una geometría y la convierte a un nuevo SRID, recalculando sus coordenadas para que representen la misma ubicación en el nuevo sistema.
            </p>
            <p>
                Es fundamental para realizar mediciones precisas. Por ejemplo, los sistemas geográficos como WGS 84 (SRID 4326) usan grados como unidad, lo cual no es útil para medir distancias o áreas. Para ello, debemos transformar los datos a un sistema proyectado que use metros, como el Origen Nacional de Colombia (SRID 9377).
            </p>
            <p><strong>Ejemplo:</strong> Convertir un polígono de un barrio de coordenadas geográficas (grados) a proyectadas (metros).</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Transforma la geometría del barrio 'VILLAS DE GRANADA' al SRID 9377
SELECT ST_AsText(ST_Transform(geom, 9377))
FROM barrios_enga
WHERE nombre = 'VILLAS DE GRANADA';</code></pre>
            </div>
            <p><strong>¡Importante!</strong> No confundas <code>ST_Transform()</code> con <code>ST_SetSRID()</code>. Mientras que <code>ST_Transform()</code> recalcula las coordenadas, <code>ST_SetSRID()</code> simplemente cambia la etiqueta del SRID sin alterar las coordenadas, lo que casi siempre es incorrecto y llevará a que tus datos se muestren en un lugar equivocado.</p>

            <h2>3. Ejercicios Prácticos de Proyección</h2>
            <p>
                Pongamos en práctica lo aprendido con datos de la localidad de Engativá.
            </p>

            <h3>Ejercicio 1: Calcular la longitud total de las vías</h3>
            <p>Si calculamos la longitud directamente sobre los datos en SRID 4326, el resultado estará en grados, lo cual no es muy informativo.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Longitud total en grados (resultado poco útil)
SELECT Sum(ST_Length(geom))
FROM vias_enga;</code></pre>
            </div>

            <p>Para obtener un resultado significativo en metros, primero debemos transformar las geometrías al SRID 9377.</p>
             <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Longitud total en metros (resultado correcto)
SELECT Sum(ST_Length(ST_Transform(geom, 9377)))
FROM vias_enga;</code></pre>
            </div>
            <p>La diferencia en los resultados será enorme y demuestra por qué la transformación es esencial para las mediciones.</p>

            <h3>Ejercicio 2: Ver la definición de un SRID</h3>
            <p>Podemos consultar la definición WKT (Well-Known Text) de cualquier SRID en la tabla <code>spatial_ref_sys</code>.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Obtener la definición WKT del Origen Nacional
SELECT srtext 
FROM spatial_ref_sys
WHERE srid = 9377;</code></pre>
            </div>

            <h3>Ejercicio 3: Realizar un cruce espacial preciso</h3>
            <p>Para saber cuántas calles cruzan la Avenida Calle 80, debemos realizar la intersección en un sistema proyectado para asegurar la precisión.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Contar las calles que intersectan la Av. Calle 80
SELECT count(vias.*)
FROM vias_enga AS vias, vias_enga AS comparada
WHERE ST_Intersects(
        ST_Transform(vias.geom, 9377),
        ST_Transform(comparada.geom, 9377)
      )
  AND comparada.mvietiquet = 'Avenida Calle 80';</code></pre>
            </div>
            <p>En esta consulta, hacemos un "auto-join" (unir una tabla consigo misma) y transformamos ambas geometrías a SRID 9377 antes de usar <code>ST_Intersects</code> para garantizar un análisis correcto.</p>

        </article>
        
        <!-- ===== PIE DE PÁGINA ===== -->
        <footer class="text-center mt-16 pt-8 border-t border-gray-300">
            <p class="text-gray-600">&copy; 2024 Universidad Distrital Francisco José de Caldas. Todos los derechos reservados.</p>
            <p class="text-sm text-gray-500 mt-1">Este material se distribuye bajo la licencia Creative Commons Atribución-CompartirIgual.</p>
        </footer>
    </div>
    <script>
        // Inicializa Highlight.js para resaltar todos los bloques de código
        hljs.highlightAll();

        // Agrega la funcionalidad de copiado a todos los botones
        const copyButtons = document.querySelectorAll('.copy-button');
        copyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pre = button.parentElement.querySelector('pre > code');
                const textToCopy = pre.innerText;

                // Usamos un textarea temporal para copiar el texto
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    button.innerText = 'Copiado!';
                    button.classList.add('copied');
                } catch (err) {
                    console.error('Error al copiar el texto: ', err);
                    button.innerText = 'Error';
                }
                document.body.removeChild(textArea);

                // Revertir el texto del botón después de 2 segundos
                setTimeout(() => {
                    button.innerText = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            });
        });
    </script>
</body>
</html>
