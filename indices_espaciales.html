<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo: Índices Espaciales - Guía de PostGIS Bogotá</title>
    <!-- Tailwind CSS para un diseño rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para el contenido del artículo */
        .article-content h2 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 800; /* extrabold */
            color: #1f2937; /* gray-800 */
            margin-top: 2.5rem; /* mt-10 */
            margin-bottom: 1rem; /* mb-4 */
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .article-content h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* bold */
            color: #1f2937; /* gray-800 */
            margin-top: 2rem; /* mt-8 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .article-content p, .article-content ul, .article-content ol {
            font-size: 1.125rem; /* text-lg */
            color: #374151; /* gray-700 */
            line-height: 1.75;
            margin-bottom: 1rem;
        }
        .article-content ul {
            list-style-type: disc;
            padding-left: 2rem;
        }
        .article-content a {
            color: #2563eb; /* blue-600 */
            text-decoration: none;
            transition: color 0.2s;
        }
        .article-content a:hover {
            color: #1d4ed8; /* blue-800 */
            text-decoration: underline;
        }
        .article-content code:not(.hljs) { /* Código inline */
            background-color: #e5e7eb;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .code-block-container {
            position: relative;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .copy-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #4b5563;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #6b7280;
        }
        .copy-button:hover {
            background-color: #374151;
        }
        .copy-button.copied {
            background-color: #16a34a; /* green-600 */
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .styled-table th, .styled-table td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        .styled-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .styled-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
    </style>
    <!-- Highlight.js para el resaltado de sintaxis SQL -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- ===== NAVEGACIÓN DE VUELTA ===== -->
        <nav class="mb-6">
            <a href="index.html" class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200 text-lg">
                &larr; Volver a la página principal de la guía
            </a>
        </nav>

        <!-- ===== CABECERA DEL MÓDULO ===== -->
        <header class="mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
                Índices Espaciales
            </h1>
            <p class="text-xl text-gray-600">
                Optimizando el rendimiento de las consultas geoespaciales en PostGIS.
            </p>
        </header>

        <article class="bg-white p-6 sm:p-8 lg:p-12 rounded-xl shadow-md border border-gray-200 article-content">
            
            <h2>1. ¿Qué son los Índices Espaciales?</h2>
            <p>
                Cuando trabajamos con grandes volúmenes de datos, la eficiencia es clave. Un <strong>índice espacial</strong> es una estructura de datos especializada que acelera drásticamente las consultas espaciales. Sin un índice, una base de datos debe comparar cada geometría de una tabla con cada geometría de otra (un método de "fuerza bruta"), lo cual es extremadamente lento.
            </p>
            <p>
                Por ejemplo, unir dos tablas de 10,000 registros cada una sin índices requeriría 100,000,000 de comparaciones. Con un índice espacial, este número podría reducirse a tan solo 20,000, mejorando el rendimiento de forma exponencial.
            </p>

            <h3>1.1. ¿Cómo funcionan? Bounding Boxes y R-Tree</h3>
            <p>
                A diferencia de los datos alfanuméricos, indexar las geometrías complejas (puntos, líneas, polígonos) directamente es muy costoso. Por ello, PostGIS utiliza una técnica inteligente: en lugar de indexar la geometría en sí, indexa su <strong>caja delimitadora</strong> (o <em>bounding box</em>), que es el rectángulo mínimo que encierra completamente al objeto.
            </p>
            <img src="imagenes/indices espaciales/imagen1.png" alt="[Imagen de Bounding Boxes de tres líneas y un polígono]" class="w-full max-w-3xl mx-auto my-4 rounded-lg shadow-md border">
            <p>
                El proceso de consulta se realiza en dos pasos:
            </p>
            <ol class="list-decimal list-inside">
                <li><strong>Paso de Filtro (rápido):</strong> Usando el índice, PostGIS encuentra rápidamente todas las <em>bounding boxes</em> que se intersectan con la <em>bounding box</em> de la geometría de interés.</li>
                <li><strong>Paso de Refinamiento (exacto):</strong> Solo para las geometrías que pasaron el primer filtro, PostGIS realiza la comparación espacial exacta (ej. <code>ST_Intersects</code>) para obtener el resultado final.</li>
            </ol>
            <p>
                Esta estructura de indexación se implementa mediante un <strong>R-Tree (Árbol-R)</strong>, que organiza las geometrías en una jerarquía de rectángulos anidados. Esto permite al sistema descartar grandes áreas del mapa muy rápidamente, enfocándose solo en las zonas relevantes.
            </p>
             <img src="imagenes/indices espaciales/imagen2.png" alt="[Imagen de la jerarquía de un R-Tree]" class="w-full max-w-lg mx-auto my-4 rounded-lg shadow-md border">

            <h2>2. Creación y Gestión de Índices en PostGIS</h2>
            <p>
                En PostGIS, los índices espaciales se crean utilizando la estructura <strong>GiST (Generalized Search Tree)</strong>, que es la implementación del R-Tree.
            </p>

            <h3>2.1. Crear un Índice Espacial</h3>
            <p>La sintaxis para crear un índice en la columna de geometría (comúnmente llamada <code>geom</code>) es la siguiente:</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">CREATE INDEX [nombre_del_indice] ON [nombre_de_la_tabla] USING GIST ([columna_geom]);</code></pre>
            </div>
            <p><strong>Ejemplo:</strong> Crear índices para nuestras capas de la localidad Rafael Uribe Uribe.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">CREATE INDEX idx_vias_geom ON vias USING GIST(geom);
CREATE INDEX idx_barrios_geom ON barrios USING GIST(geom);
CREATE INDEX idx_incidentes_geom ON incidentes USING GIST(geom);</code></pre>
            </div>

            <h3>2.2. Eliminar un Índice Espacial</h3>
            <p>Si necesitas eliminar un índice, puedes usar el comando <code>DROP INDEX</code>. Es una buena práctica incluir <code>IF EXISTS</code> para evitar errores si el índice no existe.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">DROP INDEX IF EXISTS idx_vias_geom;</code></pre>
            </div>

            <h2>3. Ejercicios Prácticos de Rendimiento</h2>
            <p>
                La mejor manera de ver el poder de los índices es comparar el rendimiento de una consulta con y sin ellos, usando el comando <code>EXPLAIN ANALYZE</code>.
            </p>
            
            <h3>Consulta 1: Incidentes por Barrio</h3>
            <p>Queremos contar cuántos incidentes ocurrieron en cada barrio.</p>
            
            <h4>Sin Índice Espacial:</h4>
            <p>Primero, nos aseguramos de que no haya índice en la tabla de incidentes. Luego, ejecutamos la consulta con <code>EXPLAIN ANALYZE</code>.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">DROP INDEX IF EXISTS idx_incidentes_geom;

EXPLAIN ANALYZE
SELECT b.nombre, COUNT(i.id)
FROM barrios b
JOIN incidentes i ON ST_Contains(b.geom, i.geom)
GROUP BY b.nombre;</code></pre>
            </div>
            <img src="imagenes/indices espaciales/imagen3.png" alt="Resultado de la consulta" class="w-full max-w-3xl mx-auto my-4 rounded-lg shadow-md border">
            <p>El plan de ejecución mostrará un "Seq Scan" (escaneo secuencial) en ambas tablas y un tiempo de ejecución relativamente alto. Por ejemplo: <strong>Execution Time: 19.564 ms</strong>.</p>
            <img src="imagenes/indices espaciales/imagen4.png" alt="Query plan explicado" class="w-full max-w-3xl mx-auto my-4 rounded-lg shadow-md border">
            <h4>Con Índice Espacial:</h4>
            <p>Ahora, creamos el índice y ejecutamos la misma consulta.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">CREATE INDEX idx_incidentes_geom ON incidentes USING GIST(geom);

EXPLAIN ANALYZE
SELECT b.nombre, COUNT(i.id)
FROM barrios b
JOIN incidentes i ON ST_Contains(b.geom, i.geom)
GROUP BY b.nombre;</code></pre>
            </div>
            <p>El nuevo plan de ejecución utilizará un "Index Scan" en la tabla de incidentes. El tiempo de ejecución se reducirá drásticamente. Por ejemplo: <strong>Execution Time: 3.754 ms</strong>. ¡Una mejora de más del 80%!</p>
<img src="imagenes/indices espaciales/imagen5.png" alt="Query plan explicado" class="w-full max-w-3xl mx-auto my-4 rounded-lg shadow-md border">
            <h3>Consulta 2: Operador && vs. ST_Intersects</h3>
            <p>
                El operador <code>&&</code> es especial porque está diseñado para usar el índice espacial directamente. Comprueba si las <em>bounding boxes</em> de dos geometrías se solapan, no si las geometrías reales lo hacen. Es mucho más rápido, pero menos preciso que <code>ST_Intersects</code>.
            </p>
            <p><strong>Ejemplo:</strong> Contar incidentes en el barrio "OLAYA".</p>
            
            <p><strong>Con el operador <code>&&</code> (rápido, pero menos preciso):</strong></p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">SELECT b.nombre, COUNT(i.id)
FROM barrios b
JOIN incidentes i ON b.geom && i.geom
WHERE b.nombre = 'OLAYA'
GROUP BY b.nombre;</code></pre>
            </div>
            <p>Resultado: <strong>68 incidentes</strong> (incluye aquellos cuya bounding box toca, aunque el punto esté fuera).</p>
<img src="imagenes/indices espaciales/imagen7.png" alt="Resultado de la consulta" class="w-full max-w-3xl mx-auto my-4 rounded-lg shadow-md border">
            <p><strong>Con la función <code>ST_Intersects</code> (más lento, pero exacto):</strong></p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">SELECT b.nombre, COUNT(i.id)
FROM barrios b
JOIN incidentes i ON ST_Intersects(b.geom, i.geom)
WHERE b.nombre = 'OLAYA'
GROUP BY b.nombre;</code></pre>
            </div>
            <p>Resultado: <strong>44 incidentes</strong> (solo los que realmente están dentro o tocan la geometría del barrio).</p>
            <img src="imagenes/indices espaciales/imagen6.png" alt="Resultado de la consulta" class="w-full max-w-3xl mx-auto my-4 rounded-lg shadow-md border">
            <p>La mejor práctica es usar ambos: el operador <code>&&</code> en la cláusula <code>WHERE</code> para hacer un filtro rápido con el índice, y la función espacial exacta en el <code>JOIN</code> o <code>WHERE</code> para el refinamiento.</p>

            <h2>4. Mantenimiento de Índices: VACUUM y ANALYZE</h2>
            <p>
                Para que el planificador de consultas de PostgreSQL tome las mejores decisiones, necesita estadísticas actualizadas sobre los datos.
            </p>
            <ul>
                <li><strong><code>VACUUM</code>:</strong> Libera espacio ocupado por filas eliminadas o actualizadas, como un "conserje" que limpia la tabla.</li>
                <li><strong><code>ANALYZE</code>:</strong> Recolecta estadísticas sobre la distribución de los datos en las tablas, como un "archivista" que actualiza los registros.</li>
            </ul>
            <p>Después de realizar cargas masivas de datos o muchas actualizaciones, es una buena práctica ejecutar:</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">VACUUM ANALYZE barrios;</code></pre>
            </div>
            <p>Esto asegura que los índices espaciales y el planificador de consultas funcionen con la máxima eficiencia. Afortunadamente, PostgreSQL tiene un proceso de "Autovacuum" que maneja esto automáticamente en la mayoría de los casos.</p>

        </article>
        
        <!-- ===== PIE DE PÁGINA ===== -->
        <footer class="text-center mt-16 pt-8 border-t border-gray-300">
            <p class="text-gray-600">&copy; 2024 Universidad Distrital Francisco José de Caldas. Todos los derechos reservados.</p>
            <p class="text-sm text-gray-500 mt-1">Este material se distribuye bajo la licencia Creative Commons Atribución-CompartirIgual.</p>
        </footer>
    </div>
    <script>
        // Inicializa Highlight.js para resaltar todos los bloques de código
        hljs.highlightAll();

        // Agrega la funcionalidad de copiado a todos los botones
        const copyButtons = document.querySelectorAll('.copy-button');
        copyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pre = button.parentElement.querySelector('pre > code');
                const textToCopy = pre.innerText;

                // Usamos un textarea temporal para copiar el texto
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    button.innerText = 'Copiado!';
                    button.classList.add('copied');
                } catch (err) {
                    console.error('Error al copiar el texto: ', err);
                    button.innerText = 'Error';
                }
                document.body.removeChild(textArea);

                // Revertir el texto del botón después de 2 segundos
                setTimeout(() => {
                    button.innerText = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            });
        });
    </script>
</body>
</html>
