<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo: Joins Espaciales - Guía de PostGIS Bogotá</title>
    <!-- Tailwind CSS para un diseño rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para el contenido del artículo */
        .article-content h2 {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 800; /* extrabold */
            color: #1f2937; /* gray-800 */
            margin-top: 2.5rem; /* mt-10 */
            margin-bottom: 1rem; /* mb-4 */
            border-bottom: 2px solid #e5e7eb; /* border-gray-200 */
            padding-bottom: 0.5rem; /* pb-2 */
        }
        .article-content h3 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* bold */
            color: #1f2937; /* gray-800 */
            margin-top: 2rem; /* mt-8 */
            margin-bottom: 1rem; /* mb-4 */
        }
        .article-content p, .article-content ul, .article-content ol {
            font-size: 1.125rem; /* text-lg */
            color: #374151; /* gray-700 */
            line-height: 1.75;
            margin-bottom: 1rem;
        }
        .article-content ul {
            list-style-type: disc;
            padding-left: 2rem;
        }
        .article-content a {
            color: #2563eb; /* blue-600 */
            text-decoration: none;
            transition: color 0.2s;
        }
        .article-content a:hover {
            color: #1d4ed8; /* blue-800 */
            text-decoration: underline;
        }
        .article-content code:not(.hljs) { /* Código inline */
            background-color: #e5e7eb;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .code-block-container {
            position: relative;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .copy-button {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: #4b5563;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #6b7280;
        }
        .copy-button:hover {
            background-color: #374151;
        }
        .copy-button.copied {
            background-color: #16a34a; /* green-600 */
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        .styled-table th, .styled-table td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        .styled-table th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .styled-table tbody tr:nth-child(odd) {
            background-color: #f9fafb;
        }
    </style>
    <!-- Highlight.js para el resaltado de sintaxis SQL -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- ===== NAVEGACIÓN DE VUELTA ===== -->
        <nav class="mb-6">
            <a href="index.html" class="text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200 text-lg">
                &larr; Volver a la página principal de la guía
            </a>
        </nav>

        <!-- ===== CABECERA DEL MÓDULO ===== -->
        <header class="mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
                Uniones Espaciales (Spatial Joins)
            </h1>
            <p class="text-xl text-gray-600">
                Combinando capas geográficas para crear nueva información y responder preguntas complejas.
            </p>
        </header>

        <article class="bg-white p-6 sm:p-8 lg:p-12 rounded-xl shadow-md border border-gray-200 article-content">
            
            <h2>1. ¿Qué es un Join Espacial?</h2>
            <p>
                Un <strong>Join Espacial</strong> es una operación que permite combinar los registros de dos tablas basándose en su relación geométrica, en lugar de hacerlo por un valor común en una columna. Esto significa que podemos unir tablas si un punto está dentro de un polígono, si dos líneas se cruzan, o si dos objetos están a una distancia determinada.
            </p>
            <p>
                A diferencia de los JOIN tradicionales de SQL, que usan condiciones como <code>ON tabla1.id = tabla2.id</code>, los Joins Espaciales utilizan las funciones de relaciones espaciales que vimos en el módulo anterior (como <code>ST_Intersects</code>, <code>ST_Contains</code>, etc.) dentro de la cláusula <code>ON</code>.
            </p>

            <h3>Comparación: JOIN Tradicional vs. JOIN Espacial</h3>
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>JOIN Tradicional</th>
                        <th>JOIN Espacial</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Se basa en atributos tabulares (ej. un ID, un código, un nombre).</td>
                        <td>Se basa en la relación geométrica entre las entidades.</td>
                    </tr>
                    <tr>
                        <td>No requiere que las tablas tengan geometría.</td>
                        <td>Es indispensable que ambas tablas tengan una columna de tipo <code>geometry</code>.</td>
                    </tr>
                     <tr>
                        <td>Ejemplo de sintaxis: <code>ON tabla1.id = tabla2.id</code></td>
                        <td>Ejemplo de sintaxis: <code>ON ST_Intersects(tabla1.geom, tabla2.geom)</code></td>
                    </tr>
                    <tr>
                        <td>Uso típico: Unir una tabla de empleados con su departamento.</td>
                        <td>Uso típico: Unir una capa de puntos de crímenes con los barrios donde ocurrieron.</td>
                    </tr>
                </tbody>
            </table>

            <h2>2. Tipos de Joins Espaciales y sus Funciones</h2>
            <p>
                La función que elijas para tu Join Espacial determinará el tipo de relación que se usará para unir los datos. A continuación, veremos las más comunes aplicadas a datos de la localidad de Barrios Unidos en Bogotá.
            </p>

            <h3>ST_Intersects (geomA, geomB)</h3>
            <p>
                Esta es la función más versátil y comúnmente utilizada. Une los registros si sus geometrías se tocan o se cruzan en cualquier punto. Es ideal para preguntas generales de "qué está en dónde".
            </p>
            <p><strong>Ejemplo:</strong> Obtener todos los incidentes y el barrio en el que ocurrieron (o con el que se intersectan).</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Devolver todos los incidentes que tocan/intersectan un barrio
SELECT
    i.id AS inicdente_id,
    b.nombre AS barrio,
    i.fecha,
    i."número_in"
FROM
    incidentes_barrios_unidos i
JOIN
    barrios b ON ST_Intersects(i.geom, b.geom);</code></pre>
            </div>

            <h3>ST_Contains (geomA, geomB)</h3>
            <p>
                Esta función es más estricta que la anterior. Une los registros solo si la geometría A contiene completamente a la geometría B. Es útil cuando se necesita una certeza absoluta de que una entidad está totalmente dentro de otra.
            </p>
            <p><strong>Ejemplo:</strong> Saber en qué barrio cayó cada incidente, asegurando que el punto del incidente esté completamente dentro del polígono del barrio.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Asegurarnos que el incidente esté totalmente contenido dentro del polígono del barrio
SELECT
    b.nombre AS barrio,
    i.id AS incidente_id,
    i.fecha
FROM
    barrios b
JOIN
    incidentes_barrios_unidos i
    ON ST_Contains(b.geom, i.geom);</code></pre>
            </div>

            <h3>ST_DWithin (geomA, geomB, distancia)</h3>
            <p>
                Esta función une registros basados en la proximidad. Es extremadamente útil para análisis de áreas de influencia o para encontrar entidades cercanas. Une los registros si la distancia entre sus geometrías es menor o igual a la especificada.
            </p>
            <p><strong>Ejemplo:</strong> Encontrar todos los incidentes que ocurrieron a 50 metros o menos de cualquier calle o vía principal.</p>
            <div class="code-block-container">
                <button class="copy-button">Copiar</button>
                <pre><code class="language-sql">-- Devolver todos los incidentes que ocurrieron a menos de 50 metros de cualquier calle
SELECT
    i.id AS inicdente_id,
    i.fecha,
    m.mvinombre AS via_cercana
FROM
    incidentes_barrios_unidos i
JOIN
    malla m ON ST_DWithin(i.geom, m.geom, 50);</code></pre>
            </div>
            <p>
                Dominar los Joins Espaciales es un paso fundamental para pasar de simplemente almacenar datos geográficos a realizar análisis espaciales significativos que pueden responder preguntas complejas sobre el territorio.
            </p>

        </article>
        
        <!-- ===== PIE DE PÁGINA ===== -->
        <footer class="text-center mt-16 pt-8 border-t border-gray-300">
            <p class="text-gray-600">&copy; 2024 Universidad Distrital Francisco José de Caldas. Todos los derechos reservados.</p>
            <p class="text-sm text-gray-500 mt-1">Este material se distribuye bajo la licencia Creative Commons Atribución-CompartirIgual.</p>
        </footer>
    </div>
    <script>
        // Inicializa Highlight.js para resaltar todos los bloques de código
        hljs.highlightAll();

        // Agrega la funcionalidad de copiado a todos los botones
        const copyButtons = document.querySelectorAll('.copy-button');
        copyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const pre = button.parentElement.querySelector('pre > code');
                const textToCopy = pre.innerText;

                // Usamos un textarea temporal para copiar el texto
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    button.innerText = 'Copiado!';
                    button.classList.add('copied');
                } catch (err) {
                    console.error('Error al copiar el texto: ', err);
                    button.innerText = 'Error';
                }
                document.body.removeChild(textArea);

                // Revertir el texto del botón después de 2 segundos
                setTimeout(() => {
                    button.innerText = 'Copiar';
                    button.classList.remove('copied');
                }, 2000);
            });
        });
    </script>
</body>
</html>
